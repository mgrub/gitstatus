\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{gitstatus}[2020/10/25 Watermark Git Information Package]

\RequirePackage{kvoptions}
\RequirePackage{catchfile}
\RequirePackage{xstring}

\DeclareStringOption[.git/]{gitdir}                    % custom git dir (can be relative)
\DeclareBoolOption[false]{watermark}                   % watermark with branch + hash on top of page
\DeclareComplementaryOption{nowatermark}{watermark}
\DeclareBoolOption[false]{novariables}                 % disable creation of variables
\ProcessKeyvalOptions*

% read needed information from git-files
%% branch name
\def\gitstatus@headpath{\gitstatus@gitdir HEAD}
\IfFileExists{\gitstatus@headpath}{
    \CatchFileDef{\gitstatus@headfull}{\gitstatus@headpath}{}
    \StrGobbleRight{\gitstatus@headfull}{1}[\gitstatus@head]
    \StrBehind[2]{\gitstatus@head}{/}[\gitstatus@branch]
}{
    \def\gitstatus@branch{NOT AVAILABLE}
    \PackageWarning{gitstatus}{Can't find HEAD (maybe check specified gitdir).}
}

%% commit hash
\def\gitstatus@branchpath{\gitstatus@gitdir refs/heads/\gitstatus@branch}
\IfFileExists{\gitstatus@branchpath}{
    \CatchFileDef{\gitstatus@commit}{\gitstatus@branchpath}{}
}{
    \def\gitstatus@commit{NOT AVAILABLE}
    \PackageWarning{gitstatus}{Can't read commit hash (maybe check specified gitdir).}
}


% make dir, branch and hash available outside of package
\ifgitstatus@novariables
\else
    \def\gitdir{\gitstatus@gitdir}
    \def\gitbranch{\gitstatus@branch}
    \def\gitcommit{\gitstatus@commit}
\fi

% include git information as watermark
\ifgitstatus@watermark
    \RequirePackage{xcolor}
    \RequirePackage[printwatermark]{xwatermark}
    \newwatermark[allpages,color=black!20,angle=0,scale=0.5,align=left,xpos=-2cm,ypos=13cm]{On branch: \texttt{\gitstatus@branch}\\ Commit: \texttt{\gitstatus@commit}}
\fi

\endinput