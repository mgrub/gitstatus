\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{gitwm}[2020/10/25 Watermark Git Information Package]

\RequirePackage{kvoptions}
\RequirePackage{catchfile}
\RequirePackage{xstring}
\RequirePackage{xcolor}
\RequirePackage[printwatermark]{xwatermark}

% specify custom (relative) path to git directory
\DeclareStringOption[]{gitdir}[.git/]

% show a watermark with the branch and commit-hash
\DeclareBoolOption[true]{watermark}

% define \gitdir
\def\gitdir{\gitwm@gitdir}

% define \gitbranch
\CatchFileDef{\headfull}{\gitdir HEAD.}{}
\StrGobbleRight{\headfull}{1}[\head]
\StrBehind[2]{\head}{/}[\gitbranch]

% define \gitcommit
\CatchFileDef{\gitcommit}{\gitdir refs/heads/\branch.}{}


% include git information as watermark
\if\gitwm@watermark
    \newwatermark[allpages,color=black!20,angle=0,scale=0.5,align=left,xpos=-2cm,ypos=13cm]{On branch: \texttt{\gitbranch}\\ Commit: \texttt{\gitcommit}}
\fi


\endinput